{% extends "base.html" %}
{% block title %}充值{% endblock %}
{% block style %}
<style type="text/css">
	.btn-default {
		margin-right: 12%;
	}
</style>
{% endblock %}
{% block content %}
	<div class="row">
		<div class="input-group col-xs-offset-1 col-xs-10">
			<span class="input-group-addon">￥</span>
			<input type="text" class="form-control" placeholder="输入你的充值">
			<span class="input-group-addon">.00</span>
		</div>
	</div>
	<hr>
	<div class="row">
		<div class="col-xs-offset-1 col-xs-10">
			<button type="button" class="btn btn-default">50</button>
			<button type="button" class="btn btn-default">100</button>
			<button type="button" class="btn btn-default">200</button>
		</div>
	</div>
	<hr>
	<div class="row">
		<div class="col-xs-offset-1 col-xs-10">
			<button type="button" class="btn btn-danger btn-lg btn-block">立即充值</button>
		</div>
	</div>
{% endblock %}
{% block js %}
	<script type="text/javascript" src="../static/js/jweixin-1.0.0.js"></script>
	<script type="text/javascript">
		var paymentSignInfo;
		$(document).ready(function() {
			$.get("{{ url_for('getPaymentConf')}} ", function(result) {
				if (result.err_code == "E0000") {
					paymentSignInfo = result.data;
					wx.config({
						debug: true,
						appId: paymentSignInfo.appId,
						timestamp: paymentSignInfo.timestamp,
						nonceStr: paymentSignInfo.nonceStr,
						signature: paymentSignInfo.signature,
						jsApiList: paymentSignInfo.jsApiList
					});
				};
			});
		});

		$('.btn-default').click(function() {
			var btnValue = $(this).html();
			$('.form-control').val(btnValue);
		});

		$('.btn-block').click(function(event) {
			event.preventDefault();
			var amount = $('.form-control').val();
			var data = {
				amount : amount
			};
			$.ajax({
				type: "POST",
				url: "{{ url_for('recharge') }}",
				data: JSON.stringify(data),
				contentType: 'application/json;charset=UTF-8',
				success: function(result) {
                    var prepayid;
                    if(result.err_code == "E0000") {
                        prepayid = result.data.prepayid;
                        var data = {
                            prepayid : prepayid
                        };
			            $.post(" {{ url_for('getPaymentConf')}} ", data, function(result) {
                            if(result.err_code == "E0000") {
                                info = result.data;
                                wx.chooseWXPay({
                                    timestamp: info.timeStamp,
                                    nonceStr: info.nonceStr,
                                    package: "prepay_id=" + prepayid,
                                    signType: "MD5",
                                    paySign: info.sign,
                                    success: function(result) {
                                    }
                                });
                            }
                        });
                    }
				}
			});
		})
	</script>
{% endblock %}
